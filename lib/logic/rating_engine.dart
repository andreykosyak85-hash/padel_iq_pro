import 'dart:math';

class RatingEngine {
  /// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ (Delta)
  /// –í—Å–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ 1.0 - 7.0, –Ω–æ –≤–Ω—É—Ç—Ä–∏ —É–º–Ω–æ–∂–∞—é—Ç—Å—è –Ω–∞ 1000
  static double calculateAdvancedDelta({
    required double currentRating,    // –¢–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥ (–Ω–∞–ø—Ä. 2.5)
    required double partnerRating,    // –†–µ–π—Ç–∏–Ω–≥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–Ω–∞–ø—Ä. 2.6)
    required double opponentAvgRating,// –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤ (–Ω–∞–ø—Ä. 2.55)
    required int gamesPlayed,         // –°–∫–æ–ª—å–∫–æ –∏–≥—Ä —Å—ã–≥—Ä–∞–ª (–æ–ø—ã—Ç)
    required double reliability,      // –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å (0.0 - 1.0)
    required double stability,        // –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (0.0 - 1.0)
    required int repetitionCount,     // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∏–≥—Ä–∞–ª —Å –Ω–∏–º–∏ (–ê–Ω—Ç–∏—Ñ–∞—Ä–º)
    required double groupTrust,       // –î–æ–≤–µ—Ä–∏–µ –∫ –º–∞—Ç—á—É/–∫–ª—É–±—É (0.0 - 1.0)
    required double formatWeight,     // –¢—É—Ä–Ω–∏—Ä (1.5) –∏–ª–∏ —Ç–æ–≤–∞—Ä–Ω—è–∫ (1.0)
    required int result,              // 1 (–ü–æ–±–µ–¥–∞) –∏–ª–∏ 0 (–ü–æ—Ä–∞–∂–µ–Ω–∏–µ)
  }) {
    // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ—á–∫–∏ (2.5 -> 2500) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª
    double pRating = currentRating * 1000;
    double partRating = partnerRating * 1000;
    double oppRating = opponentAvgRating * 1000;

    // 2. K-Factor (–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π: –Ω–æ–≤–∏—á–∫–∞–º –ª–µ–≥—á–µ —Ä–∞—Å—Ç–∏/–ø–∞–¥–∞—Ç—å)
    double K = 32.0;
    if (gamesPlayed < 10) K = 60.0;
    else if (gamesPlayed < 30) K = 40.0;

    // 3. –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ (–§–æ—Ä–º—É–ª–∞ –≠–ª–æ)
    // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–±–µ–¥—ã –æ—Ç 0 –¥–æ 1
    double expected = 1 / (1 + pow(10, (oppRating - pRating) / 400));

    // 4. –ë–∞–∑–æ–≤–∞—è –î–µ–ª—å—Ç–∞
    double delta = K * (result - expected);

    // --- üß† –ü–†–û–î–í–ò–ù–£–¢–´–ï –ú–û–î–ò–§–ò–ö–ê–¢–û–†–´ (–¢–í–û–ô –ö–û–î) ---

    // –ê. –ü–∞—Ä—Ç–Ω—ë—Ä (–ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω–µ—Ä –Ω–∞–º–Ω–æ–≥–æ —Å–∏–ª—å–Ω–µ–µ, —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –º–µ–Ω—å—à–µ)
    double partnerDiff = partRating - pRating;
    if (partnerDiff > 200) delta *= 0.9;   // "–¢–∞—â–∏–ª" –ø–∞—Ä—Ç–Ω–µ—Ä
    if (partnerDiff < -200) delta *= 1.1;  // –¢—ã "—Ç–∞—â–∏–ª" –ø–∞—Ä—Ç–Ω–µ—Ä–∞

    // –ë. üõ°Ô∏è –ê–Ω—Ç–∏—Ñ–∞—Ä–º (–ò–≥—Ä–∞ —Å –æ–¥–Ω–∏–º–∏ –∏ —Ç–µ–º–∏ –∂–µ)
    if (repetitionCount > 5) {
      delta *= 0.5; // –†–µ–∂–µ–º –≤ 2 —Ä–∞–∑–∞
    } else if (repetitionCount > 3) {
      delta *= 0.7; // –†–µ–∂–µ–º –Ω–∞ 30%
    }

    // –í. üë• –ì—Ä—É–ø–ø—ã / –î–æ–≤–µ—Ä–∏–µ
    // –ï—Å–ª–∏ –º–∞—Ç—á –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π (trust 0.5), –¥–µ–ª—å—Ç–∞ –º–µ–Ω—å—à–µ
    delta *= 1 - (1 - groupTrust) * 0.3;

    // –ì. üéÆ –§–æ—Ä–º–∞—Ç (–¢—É—Ä–Ω–∏—Ä –≤–∞–∂–Ω–µ–µ)
    delta *= formatWeight;

    // –î. üìâ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
    // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —á–∞—Å—Ç–æ –æ—Ç–º–µ–Ω—è–µ—Ç –º–∞—Ç—á–∏ (reliability –Ω–∏–∑–∫–∏–π), —Ä–µ–π—Ç–∏–Ω–≥ —Ä–∞—Å—Ç–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ
    delta *= (1 - (1 - reliability) * 0.4); 
    // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω, –¥–∞–µ–º —à–∞–Ω—Å –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–≥–∏–∫–∏)
    // –í —Ç–≤–æ–µ–π —Ñ–æ—Ä–º—É–ª–µ: delta *= (0.5 + stability * 0.5)
    // –ï—Å–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å 1.0 -> –º–Ω–æ–∂–∏—Ç–µ–ª—å 1.0. –ï—Å–ª–∏ 0.0 -> –º–Ω–æ–∂–∏—Ç–µ–ª—å 0.5.
    delta *= (0.5 + stability * 0.5);

    // 5. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–π –æ–±—Ä–∞—Ç–Ω–æ –≤ —à–∫–∞–ª—É (–¥–µ–ª–∏–º –Ω–∞ 1000)
    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 3 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π (1.340)
    return (delta / 1000); 
  }
}